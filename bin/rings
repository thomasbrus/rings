#!/usr/bin/env ruby

require 'rings'
require 'rings/client_handler'
require 'rings/acts/client'

# Start the server
server = Rings::Server.new(ARGV.first ? ARGV.first.to_i : 4567)
puts "Rings Server started on port #{server.port}."

# Gracefully exit with ctrl-c
trap('INT') { Kernel.exit(0) }

loop do
  Thread.abort_on_exception = true
  # Accept any client and set up a client handler
  Thread.start(server.accept) do |client_socket|
    client_socket.class.send :extend, Rings::Acts::Client
    client_socket.class.send :acts_as_client
    Rings::ClientHandler.new server, client_socket
  end
end