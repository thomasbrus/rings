#!/usr/bin/env ruby

require 'rings'
require 'rings/session'
require 'rings/acts/client'
require 'rings/acts/player'

server = Rings::Server.new(ARGV.first ? ARGV.first.to_i : 4567)
server.puts "Rings Server started on port #{server.port}."

# Exit gracefully using ctrl-c
trap('INT') { Kernel.exit(0) }

loop do
  Thread.abort_on_exception = true
  Thread.start(server.accept) do |client_socket|
    client_socket.class.send :include, Rings::Acts::Client
    client_socket.class.send :include, Rings::Acts::Player
    client_socket.class.send :acts_as_client
    client_socket.class.send :acts_as_player
    Rings::Session.new server, client_socket
  end
end